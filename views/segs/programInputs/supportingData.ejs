<style>
    .container {
        max-width: 90%;
    }
</style>
<style>
    .loading {
        display: none;
        position: fixed;
        top: 40%;
        left: 45%;
        transform: translate(-50%, -50%);
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .navigationButtons {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 25px;
            box-shadow: 0 0 3px rgba(0, 0, 0, 1);
            position: fixed;
            top: 48%;
            bottom: 48%;
            text-decoration: none;
            color: black;
            background-color: white;

            @media print {
                display: none;
            }
        }

        .navigationButtons:hover {
            opacity: 0.8;
            cursor: pointer;
        }

        #previousButton {
            left: 0px;

        }

        #nextButton {
            right: 0px;
            rotate: 180deg;
        }

        #overlay {
            position: fixed;
            display: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* semi-transparent background */
            z-index: 9998; /* Just below the loading circle */
        }
</style>
<div id="loadingCircle" class="loading" style="z-index: 10000;"></div>
<div id="overlay"></div>
<% layout('/layouts/boilerplate') %>
<% const seg=program.seg %>

    <a href="/plant/<%= currentPlant._id %>/seg/<%= seg._id %>/aosr/<%= program._id %>" id="previousButton"
    class="border border-0 border-start-0 border navigationButtons">
        ←
    </a>
    <a href="/plant/<%= currentPlant._id %>/seg/<%= seg._id %>/conclusion/<%= program._id %>" id="nextButton"
    class="border border-0 border-start-0 border navigationButtons">
        ←
    </a>

<a id="backToSegButton" class="btn btn-primary"
            href="/plant/<%= currentPlant._id %>/seg/<%= seg.segInstruction._id %>">
            Back to <%=seg.segInstruction.segInstructionID %>
</a>

<div class="row px-auto">
    <div class="col mb-3">
        <form id="putForm"
            action="/plant/<%= currentPlant._id %>/seg/<%= seg.segInstruction._id %>/supportingData/<%= program._id %>?_method=PUT"
            method="post" enctype="multipart/form-data">
            <div class="my-3">
                <h1 class="fs-3 d-inline">
                    <%=seg.segInstruction.segInstructionID %>, <%=program.name %>, Supporting Data
                </h1>
                <div class="mx-2 d-inline">
                    <button id="saveSupportingDataButton" type="button" onclick="updateData()" class="btn btn-success me-1">Save</button>
                    <div class="d-inline" id="savingIcon">Saved</div>
                </div>
            </div>
            <div id="supportingData-<%= program._id %>">
                <textarea class="form-control"
                name="supportingData"><%= program.supportingData[0] !== '' ? program.supportingData[0] : '' %></textarea>
            </div>
            
        </form>

        <div class="row">
            <div class="mt-5 col-12 col-lg-5">
                <label class="form-label" for="fileInput">Upload PDF File</label>
                <input id="fileInput" name="fileInput" type="file" accept=".pdf" class="form-control mb-2"
                    multiple>
            </div>
        
            <div id="filesSection" class="col-12 col-lg-7 ">
                <% if (program.supportingDataFiles.length) { %>
                <form class="mt-5" id="fileForm" method="post">
                    <ul id="fileListContainer" class="list-group">
                        
                        <li id="deleteHeader" class="list-group-item d-flex align-items-center justify-content-between px-3">
                            <div class="py-2">
                                <input class="border" type="checkbox" id="selectAllCheck">
                                <label id="checkedCount" class="d-inline ps-3">0 Files Selected</label>
                                <button disabled type="button" id="downloadFilesButton" form="fileForm" class="btn btn-secondary ms-2">Download</button>
                            </div>
                            <% if (currentUser.admin) { %>
                            <button disabled type="button" form="fileForm" class="btn btn-danger"
                            id="deleteFilesButton">
                                Delete
                            </button>
                            <% } %>
                        </li>
                        <% program.supportingDataFiles.forEach((file, i)=> { %>
                        <li class="list-group-item d-flex justify-content-between">
                            <div class="d-flex pt-2">
                                <div class="">
                                    <input id="file<%=i%>" name="files[]"
                                    value="<%=file._id%>" type="checkbox"
                                    class="form-check mb-2 deleteCheck">
                                </div>
                                <label class="form-label px-3 text-wrap" for="file<%=i%>">
                                    <%= file.originalName %>
                                </label>
                            </div>
                            <div class="row ps-3">
                                <div class="col pe-5 py-2">
                                    <% const date = file.uploadDate.toISOString().split('T')[0]%>
                                    <b>Upload Date:</b> <%= date.substring(5,7) %>/<%= date.substring(8,10) %>/<%= date.substring(0,4) %>
                                </div>
                                <div class="col-3 d-flex my-auto justify-content-end">
                                    <div class="">
                                        <button type="button" class="btn btn-primary"
                                            onclick="showPDF('<%=file.location%>')">View
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <% }) %>
                    </ul>
                </form>
                <% } %>
            </div>
        </div>
    </div>
    <div id="pdfSection" class="col-xl-6" style="position: relative; display: none;">
        <div class="text-end mb-2">
            <button class="btn btn-secondary" onclick="closePDF()">Close</button>
        </div>
        <div class="text-center">
            <iframe id="pdfWindow" class="rounded d-inline" style="width: 100%; height: 1000px;"></iframe>
        </div>
        <div class="loading" id="loading"
            style="display: block; position: absolute; top: 50%; left: 45%; transform: translate(-50%, -50%); z-index: 1000;">
        </div>
    </div>

</div>




        <!-- NicEdit -->
        <script src="/js/nicEdit.js" type="text/javascript"></script>
        <script type="text/javascript">bkLib.onDomLoaded(nicEditors.allTextAreas);</script>
        <script>
            const programID = '<%=program._id%>';
            const currentPlantID = '<%=currentPlant._id%>';
            const segID = '<%=seg.segInstruction._id%>';
            const segNumID = '<%=seg.segInstruction.segInstructionID%>'
        </script>

        <script src="/js/segSupportingData.js"></script>

<script>
    document.querySelector('title').innerHTML = `ARC <%= currentPlant.name %>, <%=seg.segInstruction.segInstructionID %>, <%=program.name %>, Supporting Data`;
</script>