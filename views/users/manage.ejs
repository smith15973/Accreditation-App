<% layout('layouts/boilerplate')%>

<h1 class="d-flex align-items-center inline-elements">
    <div>View Members of:</div>
    <select
        onchange="window.location=`/user/manage/${this.value}`"
        class="ms-2 border-0 fw-light" name="plantSelect" id="plantSelect">
        <% for (let plant of currentUser.plants) { %>
        <option <%= currentPlant._id.toString() === plant._id.toString() ? 'selected' : '' %> value="<%= plant._id %>"><%= plant.name %></option>
        <% } %>
    </select>
</h1>

<input type="text" id="userSearch" class="form-control mb-2" placeholder="Search Users">
<ul class="list-group mb-2" id="searchResultBox">
    
</ul>
<% if (requestingUsers.length && currentUser.admin) { %>
<h3>Requests for Access</h3>
<ul class="list-group mb-3">
    <% for (let user of requestingUsers) { %>
        <li class="list-group-item">
            <div class="row">
            <div class="col-3 col-sm- my-auto">
                <%= user.firstName %> <%= user.lastName %>
            </div>
            <div class="col-3 col-sm- my-auto">
                <b>Email:</b> <%= user.email %>
            </div>

            <div class="col-3 col-sm- text-start my-auto">
                    <b>Rank:</b> <%= user.admin ? 'Admin' : 'Member' %>
            </div>
            
            <div class="col-3 col-sm- text-end my-auto">
                <form class="d-inline" action="/user/<%= user._id %>/manage/<%= currentPlant._id %>?_method=DELETE&status=requested" method="post">
                    <button class="btn btn-danger">Deny</button>
                </form>
                <form class="d-inline" action="/user/<%= user._id %>/manage/<%= currentPlant._id %>?_method=PUT&status=requested" method="post">
                    <button class="btn btn-success">Approve</button>
                </form>

            </div>
        </div>
        </li>
    <% } %>
</ul>
<% } %>

<h3>Plant Members</h3>
<ul class="list-group mb-3">
    <% for (let user of approvedUsers) { %>
        <li class="list-group-item">
            <div class="row">
                <div class="col-3 col-sm- my-auto">
                    <%= user.firstName %> <%= user.lastName %>
                </div>
                <div class="col-3 col-sm- my-auto">
                    <%= user.email %>
                </div>
                <div class="col-3 col-sm- text-start my-auto">
                    <% if (currentUser.admin && !user.admin) { %>
                    <form class="d-flex align-items-center" action="/user/<%= user._id %>/manage/<%= currentPlant._id %>?_method=PUT&rank=changed" method="post">
                        <select class="rankSelect form-control" name="rank" id="adminSelect">
                            <option value="member">Member</option>
                            <option <%= user.admin ? 'selected' : '' %> value="admin">Admin</option>
                        </select>
                    </form>
                    <% } else { %>
                        <%= user.admin ? 'Admin' : 'Member' %>
                    <% } %>
                </div>
                <div class="col-3 col-sm- text-end my-auto">
                    <% if (currentUser.admin && !user.admin) { %>
                    <form class="" action="/user/<%= user._id %>/manage/<%= currentPlant._id %>?_method=DELETE" method="post">
                        <button class="btn btn-danger">Remove Access</button>
                    </form>
                    <% } %>
                </div>
            </div>
        </li>
    <% } %>
</ul>


<script>
    document.querySelector('title').innerHTML = `ARC <%=currentPlant.name%> Manage Members`;
    const currentPlantID = '<%= currentPlant._id %>'
    const currentUserAdmin = '<%= currentUser.admin %>'
</script>
<script src="/js/manageUsers.js"></script>